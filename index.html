<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Üniversite Memnuniyet Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <style>
    :root {
      --chart-1: #8884d8;
      --chart-2: #82ca9d;
      --chart-3: #ffc658;
      --chart-4: #ff7300;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f8fafc;
      color: #0f172a;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .dashboard-container {
      max-width: 80rem;
      margin: 0 auto;
      padding: 1.5rem;
    }
    .card {
      background: white;
      border-radius: 0.625rem;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .card-header {
      padding: 1.5rem 1.5rem 0 1.5rem;
    }
    .card-content {
      padding: 1.5rem;
    }
    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0;
    }
    .grid {
      display: grid;
      gap: 1.5rem;
    }
    .grid-cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }
    .grid-cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    .grid-cols-4 {
      grid-template-columns: repeat(4, 1fr);
    }
    .tabs {
      width: 100%;
    }
    .tabs-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      background: #f1f5f9;
      border-radius: 0.375rem;
      padding: 0.25rem;
      margin-bottom: 1.5rem;
    }
    .tab-button {
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      border: none;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-active {
      background: white;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    .chart-container {
      height: 24rem;
      position: relative;
    }
    .chart-container-sm {
      height: 20rem;
      position: relative;
    }
    .progress-bar {
      width: 100%;
      background: #e2e8f0;
      border-radius: 9999px;
      height: 0.5rem;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 9999px;
      transition: width 0.5s ease;
    }
    .text-center {
      text-align: center;
    }
    .text-muted {
      color: #64748b;
    }
    .text-sm {
      font-size: 0.875rem;
    }
    .text-lg {
      font-size: 1.125rem;
    }
    .text-3xl {
      font-size: 1.875rem;
    }
    .font-bold {
      font-weight: 700;
    }
    .font-medium {
      font-weight: 500;
    }
    .space-y-2 > * + * {
      margin-top: 0.5rem;
    }
    .space-y-3 > * + * {
      margin-top: 0.75rem;
    }
    .space-y-6 > * + * {
      margin-top: 1.5rem;
    }
    .flex {
      display: flex;
    }
    .items-center {
      align-items: center;
    }
    .justify-between {
      justify-content: space-between;
    }
    .space-x-2 > * + * {
      margin-left: 0.5rem;
    }
    .border-l-4 {
      border-left: 4px solid;
    }
    .border-t {
      border-top: 1px solid #e2e8f0;
    }
    .pt-2 {
      padding-top: 0.5rem;
    }
    .pt-6 {
      padding-top: 1.5rem;
    }
    .pb-3 {
      padding-bottom: 0.75rem;
    }
    .p-6 {
      padding: 1.5rem;
    }
    .w-3 {
      width: 0.75rem;
    }
    .h-3 {
      height: 0.75rem;
    }
    .w-16 {
      width: 4rem;
    }
    .rounded-full {
      border-radius: 9999px;
    }
    .hidden {
      display: none;
    }
    .bg-chart-1 {
      background-color: var(--chart-1);
    }
    .bg-chart-2 {
      background-color: var(--chart-2);
    }
    .bg-chart-3 {
      background-color: var(--chart-3);
    }
    .bg-chart-4 {
      background-color: var(--chart-4);
    }
    /* Yeni stiller */
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      color: #2c3e50;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    .header p {
      color: #7f8c8d;
      font-size: 1.1rem;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
      align-items: center;
      justify-content: center;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    label {
      font-weight: 600;
      color: #34495e;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    select, button {
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid #e1e8ed;
      border-radius: 10px;
      background: white;
      color: #2c3e50;
      transition: all 0.3s ease;
      min-width: 200px;
    }
    select:focus, button:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    button {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      min-width: auto;
      padding: 12px 24px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
    }
    .message {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      text-align: center;
    }
    .loading { background-color: #fff3cd; color: #856404; }
    .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border-left: 4px solid #3498db;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #2c3e50;
    }
    .stat-label {
      color: #7f8c8d;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    /* Karşılaştırma kontrolleri */
    .compare-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
        align-items: center;
        justify-content: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    .compare-btn {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
    }
    .compare-btn:hover {
        background: linear-gradient(135deg, #219653, #27ae60);
    }
    .compare-btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
    }
    @media (min-width: 768px) {
      .md\:grid-cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .md\:grid-cols-4 {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    @media (min-width: 1024px) {
      .lg\:grid-cols-3 {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container space-y-6">
    <!-- Header -->
    <div class="header">
      <h1>📊 Üniversite Memnuniyet Dashboard</h1>
      <p>Üniversitelerin yıllara göre gelişim ve memnuniyet analizi (Pure Chart.js ile)</p>
    </div>
    <!-- Mesajlar -->
    <div id="loadingMessage" class="message loading" style="display: none;">
      🔄 Veriler yükleniyor...
    </div>
    <div id="errorMessage" class="message error" style="display: none;"></div>
    <div id="successMessage" class="message success" style="display: none;"></div>
    <div id="warningMessage" class="message warning" style="display: none;"></div>
    <!-- Kontroller -->
    <div class="controls">
      <div class="control-group">
        <label for="universitySelect">🏫 Üniversite</label>
        <select id="universitySelect">
          <option value="">Yükleniyor...</option>
        </select>
      </div>
      <button id="exportBtn" onclick="exportChart()">📥 Grafiği İndir</button>
      <button onclick="location.reload()">🔁 Yeniden Yükle</button>
    </div>
    <!-- Main Charts -->
    <div id="mainContent" style="display: none;">
      <div class="grid">
        <!-- Yearly Progress Chart -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Üniversitelere Göre Yıllık Gelişim</h3>
          </div>
          <div class="card-content">
            <div class="chart-container">
              <canvas id="lineChart"></canvas>
            </div>
          </div>
        </div>
        <!-- Tabs -->
        <div class="tabs">
          <div class="tabs-list">
            <button class="tab-button tab-active" data-tab="categories">Kategori Analizi</button>
            <button class="tab-button" data-tab="comparison">Üniversite Karşılaştırması</button>
          </div>
          <div id="categoriesTab" class="tab-content space-y-6">
            <!-- Category Overview -->
            <div class="grid md:grid-cols-2">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Genel Kategori Performansı</h3>
                </div>
                <div class="card-content">
                  <div class="chart-container-sm">
                    <canvas id="polarChart"></canvas>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Kategori Dağılımı</h3>
                </div>
                <div class="card-content">
                  <div class="chart-container-sm">
                    <canvas id="pieChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <!-- Category Cards -->
            <div id="categoryCards" class="grid md:grid-cols-2 lg:grid-cols-3">
              <!-- Category cards will be inserted here by JS -->
            </div>
          </div>
          <div id="comparisonTab" class="tab-content hidden space-y-6">
            <!-- Karşılaştırma Kontrolleri -->
            <div class="compare-controls">
              <div class="control-group">
                <label for="compareUni1">🏫 Üniversite 1</label>
                <select id="compareUni1">
                  <option value="">Üniversite seçiniz...</option>
                </select>
              </div>
              <div class="control-group">
                <label for="compareUni2">🏫 Üniversite 2</label>
                <select id="compareUni2">
                  <option value="">Üniversite seçiniz...</option>
                </select>
              </div>
              <button id="compareBtn" class="compare-btn" onclick="renderComparisonChart()" disabled>📊 Karşılaştır</button>
            </div>
            <!-- Karşılaştırma Grafiği -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Üniversite Karşılaştırması - Tüm Kategoriler</h3>
              </div>
              <div class="card-content">
                <div class="chart-container">
                  <canvas id="barChartComparison"></canvas>
                </div>
              </div>
            </div>
            <!-- University Performance Cards -->
            <div id="universityCardsComparison" class="grid md:grid-cols-2">
              <!-- University cards will be inserted here by JS -->
            </div>
          </div>
        </div>
      </div>
      <!-- Statistics Summary -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="maxScore">%</div>
          <div class="stat-label">En Yüksek Ortalama</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="minScore">%</div>
          <div class="stat-label">En Düşük Ortalama</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgScore">%</div>
          <div class="stat-label">Genel Ortalama</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="uniCount"></div>
          <div class="stat-label">Toplam Üniversite</div>
        </div>
        <!-- Yeni İstatistik Kartı -->
        <div class="stat-card">
          <div class="stat-value" id="difference2025">%</div>
          <div class="stat-label">2025 Türkiye Farkı</div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <div class="text-center text-sm text-muted pt-6 border-t">
      <p>Veriler <a href="https://github.com/sisbas/UniversiteMemnuniyet/blob/9eccba2a120985ba18aaf05fbe5ca37c00ca2bd8/universite_kategori_yil_puan.json" target="_blank">GitHub</a>'dan çekilmektedir. Pure Chart.js kütüphanesi ile interaktif grafikler sunulmaktadır.</p>
    </div>
  </div>
  <script>
    // Global variables
    let data = {};
    let chartInstances = {};
    const EXCLUDED_CATEGORY = "Genel Memnuniyet";
    const CATEGORY_ORDER = [
      "Öğrenim Deneyiminin Tatminkârlığı",
      "Yerleşke ve Yaşamının Doyuruculuğu",
      "Akademik Destek ve İlgi",
      "Kurumun Yönetim ve İşleyişinden Memnuniyet",
      "Öğrenme İmkân ve Kaynaklarının Zenginliği",
      "Kişisel Gelişim ve Kariyer Desteği",
      "Genel Memnuniyet"
    ];
    const DATA_URL = "https://raw.githubusercontent.com/sisbas/UniversiteMemnuniyet/9eccba2a120985ba18aaf05fbe5ca37c00ca2bd8/universite_kategori_yil_puan.json";

    // Utility functions
    function showElement(id) {
      document.getElementById(id).style.display = 'block';
    }
    function hideElement(id) {
      document.getElementById(id).style.display = 'none';
    }
    function showMessage(type, message) {
        const element = document.getElementById(type + 'Message');
        element.textContent = message;
        showElement(type + 'Message');
        console.log(`[${type.toUpperCase()}]`, message);
    }
    function hideMessage(type) {
        hideElement(type + 'Message');
    }
    function hideAllMessages() {
        ['loading', 'error', 'success', 'warning'].forEach(type => hideMessage(type));
    }

    // Fetch data directly from GitHub permalink
    async function fetchData() {
      try {
        showElement('loadingMessage');
        hideAllMessages();
        hideElement('mainContent');

        console.log("Veri çekiliyor:", DATA_URL);
        const response = await fetch(DATA_URL, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
            },
            cache: 'no-cache' // Always fetch fresh data
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || (!contentType.includes('application/json') && !contentType.includes('text/plain'))) {
            throw new Error(`Beklenen JSON formatı değil. Content-Type: ${contentType}`);
        }

        const rawData = await response.text();
        console.log("Ham veri alındı. İlk 200 karakter:", rawData.substring(0, 200) + (rawData.length > 200 ? "..." : ""));

        // Try to parse JSON
        try {
            data = JSON.parse(rawData);
        } catch (parseError) {
            console.error("JSON Parse Hatası:", parseError);
            console.error("Ham veri (ilk 1000 karakter):", rawData.substring(0, 1000));
            throw new Error(`JSON verisi işlenemedi. Hata: ${parseError.message}. Veri bozuk olabilir.`);
        }

        // Validate data structure
        if (!data || typeof data !== 'object' || Object.keys(data).length === 0) {
            throw new Error('Yüklenen veri boş veya geçersiz bir nesne değil.');
        }

        console.log("--- Veri Yükleme İşlemi Başarılı ---");
        console.log("Yüklenen üniversite sayısı:", Object.keys(data).length);
        console.log("İlk üniversite:", Object.keys(data)[0]);

        showMessage('success', `✅ Canlı veri başarıyla yüklendi. ${Object.keys(data).length} üniversite bulundu.`);
        setTimeout(() => hideMessage('success'), 3000);

      } catch (error) {
        console.error("--- Veri Yükleme İşlemi BAŞARISIZ ---");
        console.error("Hata detayı:", error);
        showMessage('error', `❌ Veri yüklenirken hata oluştu: ${error.message}`);
        // Do not generate sample data, just show error
        data = {}; // Clear data on error
      } finally {
        // Populate controls even if data is empty to show error state
        populateUniversityList();
        populateComparisonLists();
        hideElement('loadingMessage');
        showElement('mainContent');
      }
    }

    // Populate university dropdown
    function populateUniversityList() {
      const select = document.getElementById('universitySelect');
      select.innerHTML = '<option value="">Üniversite seçiniz...</option>';
      
      if (!data || Object.keys(data).length === 0) {
          select.innerHTML += '<option value="" disabled>Veri bulunamadı</option>';
          return;
      }

      const sortedUniversities = Object.keys(data).sort((a,b) => 
        a.localeCompare(b, "tr", {sensitivity:"base"})
      );
      
      sortedUniversities.forEach(university => {
        const option = document.createElement('option');
        option.value = university;
        option.textContent = university;
        select.appendChild(option);
      });

      select.addEventListener('change', handleUniversityChange);
    }
    
    // Populate comparison dropdowns
    function populateComparisonLists() {
      const select1 = document.getElementById('compareUni1');
      const select2 = document.getElementById('compareUni2');
      const compareBtn = document.getElementById('compareBtn');
      
      select1.innerHTML = '<option value="">Üniversite seçiniz...</option>';
      select2.innerHTML = '<option value="">Üniversite seçiniz...</option>';
      
      if (!data || Object.keys(data).length === 0) {
          select1.innerHTML += '<option value="" disabled>Veri bulunamadı</option>';
          select2.innerHTML += '<option value="" disabled>Veri bulunamadı</option>';
          return;
      }

      const sortedUniversities = Object.keys(data).sort((a,b) => 
        a.localeCompare(b, "tr", {sensitivity:"base"})
      );
      
      sortedUniversities.forEach(university => {
        const option1 = document.createElement('option');
        option1.value = university;
        option1.textContent = university;
        select1.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = university;
        option2.textContent = university;
        select2.appendChild(option2);
      });

      // Event listeners for comparison selects
      select1.addEventListener('change', checkComparisonInputs);
      select2.addEventListener('change', checkComparisonInputs);
    }
    
    // Check if both universities are selected for comparison
    function checkComparisonInputs() {
      const uni1 = document.getElementById('compareUni1').value;
      const uni2 = document.getElementById('compareUni2').value;
      const compareBtn = document.getElementById('compareBtn');
      
      if (uni1 && uni2 && uni1 !== uni2) {
        compareBtn.disabled = false;
      } else {
        compareBtn.disabled = true;
      }
    }

    // Handle university selection
    function handleUniversityChange() {
      const university = this.value;
      if (!university) {
        // Hide all charts if no university is selected
        Object.values(chartInstances).forEach(chart => {
          if (chart) chart.destroy();
        });
        chartInstances = {};
        document.getElementById('categoryCards').innerHTML = '';
        document.getElementById('universityCardsComparison').innerHTML = '';
        document.querySelectorAll('.stat-card .stat-value').forEach(el => el.textContent = '');
        return;
      }
      renderAllCharts(university);
    }

    // Calculate difference with Turkey average for 2025
    function calculateDifference2025(university, categories) {
      const year = "2025";
      const uniScores = [];
      
      categories.forEach(cat => {
        if (data[university][cat] && data[university][cat][year] !== undefined) {
          uniScores.push(data[university][cat][year]);
        }
      });
      
      if (uniScores.length === 0) return null;
      
      const uniAvg = uniScores.reduce((a, b) => a + b, 0) / uniScores.length;
      
      // Calculate national average for 2025
      const allScores = [];
      Object.keys(data).forEach(uni => {
        categories.forEach(cat => {
          if (data[uni][cat] && data[uni][cat][year] !== undefined) {
            allScores.push(data[uni][cat][year]);
          }
        });
      });
      
      if (allScores.length === 0) return null;
      
      const nationalAvg = allScores.reduce((a, b) => a + b, 0) / allScores.length;
      
      return uniAvg - nationalAvg;
    }

    // Render all charts for selected university
    function renderAllCharts(university) {
      if (!data[university]) {
        console.error("Seçilen üniversite için veri bulunamadı:", university);
        return;
      }

      // Filter categories (exclude "Genel Memnuniyet")
      let categories = Object.keys(data[university]).filter(cat => cat !== EXCLUDED_CATEGORY);
      // Use CATEGORY_ORDER for consistent sorting
      categories = CATEGORY_ORDER.filter(cat => categories.includes(cat));
      
      // Get all years for the university
      let allYears = new Set();
      categories.forEach(cat => {
        Object.keys(data[university][cat]).forEach(year => allYears.add(year));
      });
      let years = Array.from(allYears).sort();

      // Prepare data for line chart (yearly progress)
      const lineData = categories.map(category => {
        return years.map(year => data[university][category][year] || null);
      });

      // Prepare data for pie and polar charts (category averages)
      const categoryAverages = categories.map(category => {
        const scores = years.map(year => data[university][category][year]).filter(score => score !== null && score !== undefined);
        if (scores.length === 0) return 0;
        return scores.reduce((a, b) => a + b, 0) / scores.length;
      });

      // Prepare data for bar chart (university comparison)
      const universities = Object.keys(data);
      const universityAverages = universities.map(uni => {
        // Filter categories for comparison (exclude "Genel Memnuniyet")
        const uniCategories = Object.keys(data[uni]).filter(cat => cat !== EXCLUDED_CATEGORY);
        // Use CATEGORY_ORDER for consistent sorting
        const orderedUniCategories = CATEGORY_ORDER.filter(cat => uniCategories.includes(cat));
        
        const uniYears = new Set();
        orderedUniCategories.forEach(cat => {
          Object.keys(data[uni][cat]).forEach(year => uniYears.add(year));
        });
        const uniYearsArray = Array.from(uniYears).sort();
        
        const scores = orderedUniCategories.map(category => {
          const catScores = uniYearsArray.map(year => data[uni][category][year]).filter(score => score !== null && score !== undefined);
          if (catScores.length === 0) return 0;
          return catScores.reduce((a, b) => a + b, 0) / catScores.length;
        });
        
        if (scores.length === 0) return 0;
        return scores.reduce((a, b) => a + b, 0) / scores.length;
      });

      // Colors for charts
      const colors = [
        '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
        '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#d35400'
      ];

      // Destroy existing charts
      Object.values(chartInstances).forEach(chart => {
        if (chart) chart.destroy();
      });

      // Line Chart
      const lineCtx = document.getElementById('lineChart').getContext('2d');
      chartInstances.line = new Chart(lineCtx, {
        type: 'line',
        data: { // <-- DÜZELTME: 'data' anahtarı eklendi
          labels: years,
          datasets: categories.map((category, index) => ({
            label: category,
            data: lineData[index], // <-- DÜZELTME: 'data' anahtarı eklendi
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            borderWidth: 3,
            tension: 0.4,
            pointRadius: 6,
            pointHoverRadius: 8,
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `${university} - Yıllık Gelişim`,
              font: { size: 16, weight: 'bold' },
              color: '#2c3e50'
            },
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20,
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#ddd',
              borderWidth: 1,
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              min: 0,
              max: 100,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
              },
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
              }
            }
          }
        }
      });

      // Pie Chart
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      chartInstances.pie = new Chart(pieCtx, {
        type: 'pie',
        data: { // <-- DÜZELTME: 'data' anahtarı eklendi
          labels: categories,
          datasets: [{
            data: categoryAverages, // <-- DÜZELTME: 'data' anahtarı eklendi
            backgroundColor: categories.map((_, index) => colors[index % colors.length]),
            borderColor: '#fff',
            borderWidth: 2,
            hoverBorderWidth: 3,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Kategori Dağılımı',
              font: { size: 16, weight: 'bold' },
              color: '#2c3e50'
            },
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true,
                font: {
                  size: 12,
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': ' + context.parsed.toFixed(1) + '%';
                }
              }
            }
          }
        }
      });

      // Polar Area Chart
      const polarCtx = document.getElementById('polarChart').getContext('2d');
      chartInstances.polar = new Chart(polarCtx, {
        type: 'polarArea',
        data: { // <-- DÜZELTME: 'data' anahtarı eklendi
          labels: categories.map(cat => cat.split(' ')[0]), // Shortened labels
          datasets: [{
            data: categoryAverages, // <-- DÜZELTME: 'data' anahtarı eklendi
            backgroundColor: categories.map((_, index) => colors[index % colors.length] + '80'),
            borderColor: categories.map((_, index) => colors[index % colors.length]),
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Genel Kategori Performansı',
              font: { size: 16, weight: 'bold' },
              color: '#2c3e50'
            },
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                usePointStyle: true,
              }
            }
          },
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              ticks: {
                stepSize: 20,
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });

      // Bar Chart (University Comparison) - This will be replaced by the new comparison chart
      chartInstances.bar = null; // Placeholder, actual chart is in comparison tab

      // Populate category cards
      const categoryCardsContainer = document.getElementById('categoryCards');
      categoryCardsContainer.innerHTML = '';
      categories.forEach((category, index) => {
        const scores = years.map(year => data[university][category][year]).filter(score => score !== null && score !== undefined);
        if (scores.length === 0) return;
        const averageScore = scores.reduce((a, b) => a + b, 0) / scores.length;
        
        const card = document.createElement('div');
        card.className = 'card border-l-4';
        card.style.borderLeftColor = colors[index % colors.length];
        card.innerHTML = `
          <div class="card-header pb-3">
            <h4 class="card-title text-lg">${category}</h4>
          </div>
          <div class="card-content space-y-2">
            <div class="flex items-center space-x-2">
              <div class="progress-bar" style="flex: 1;">
                <div
                  class="progress-fill"
                  style="
                    background-color: ${colors[index % colors.length]};
                    width: ${averageScore}%
                  "
                ></div>
              </div>
              <span class="text-sm font-medium">${averageScore.toFixed(1)}%</span>
            </div>
          </div>
        `;
        categoryCardsContainer.appendChild(card);
      });

      // Populate university cards (top 6 for example)
      const universityCardsContainer = document.getElementById('universityCards'); // Note: This ID was missing in original, using a placeholder logic
      // Since the original tab structure is different, we'll populate the comparison cards instead for now
      // or you can add a new section for these cards if needed.
      // For this version, we'll skip this part to keep it simple and focused on the main chart.

      // Update statistics summary
      if (categoryAverages.length > 0) {
        document.getElementById('maxScore').textContent = Math.max(...categoryAverages).toFixed(1) + '%';
        document.getElementById('minScore').textContent = Math.min(...categoryAverages).toFixed(1) + '%';
        const overallAvg = categoryAverages.reduce((a, b) => a + b, 0) / categoryAverages.length;
        document.getElementById('avgScore').textContent = overallAvg.toFixed(1) + '%';
        
        // Calculate and display 2025 difference
        const diff2025 = calculateDifference2025(university, categories);
        const diffElement = document.getElementById('difference2025');
        if (diff2025 !== null) {
          diffElement.textContent = (diff2025 > 0 ? '+' : '') + diff2025.toFixed(1) + '%';
          diffElement.style.color = diff2025 >= 0 ? '#27ae60' : '#e74c3c'; // Green for positive, red for negative
        } else {
          diffElement.textContent = 'Veri Yok';
          diffElement.style.color = '#7f8c8d';
        }
      }
      document.getElementById('uniCount').textContent = universities.length;
    }
    
    // Render comparison chart for two selected universities
    function renderComparisonChart() {
      const uni1 = document.getElementById('compareUni1').value;
      const uni2 = document.getElementById('compareUni2').value;
      
      if (!uni1 || !uni2 || uni1 === uni2) {
        alert('Lütfen iki farklı üniversite seçin.');
        return;
      }
      
      // Filter categories (exclude "Genel Memnuniyet")
      let categories = [...new Set([
        ...Object.keys(data[uni1] || {}),
        ...Object.keys(data[uni2] || {})
      ])].filter(cat => cat !== EXCLUDED_CATEGORY);
      
      // Use CATEGORY_ORDER for consistent sorting
      categories = CATEGORY_ORDER.filter(cat => categories.includes(cat));
      
      // Get all years for both universities
      let allYears = new Set();
      [uni1, uni2].forEach(uni => {
        categories.forEach(cat => {
          if (data[uni] && data[uni][cat]) {
            Object.keys(data[uni][cat]).forEach(year => allYears.add(year));
          }
        });
      });
      let years = Array.from(allYears).sort();
      
      // Prepare data for comparison chart
      const datasets = [uni1, uni2].map((university, uniIndex) => {
        const uniData = data[university] || {};
        const categoryAverages = categories.map(category => {
          const catData = uniData[category] || {};
          const scores = years.map(year => catData[year]).filter(score => score !== null && score !== undefined);
          if (scores.length === 0) return 0;
          return scores.reduce((a, b) => a + b, 0) / scores.length;
        });
        
        return {
          label: university,
          data: categoryAverages, // <-- DÜZELTME: 'data' anahtarı eklendi
          backgroundColor: uniIndex === 0 ? 'rgba(52, 152, 219, 0.7)' : 'rgba(231, 76, 60, 0.7)',
          borderColor: uniIndex === 0 ? 'rgba(52, 152, 219, 1)' : 'rgba(231, 76, 60, 1)',
          borderWidth: 1
        };
      });
      
      // Destroy existing comparison chart if it exists
      if (chartInstances.barComparison) {
        chartInstances.barComparison.destroy();
      }
      
      // Create new comparison chart
      const barCtx = document.getElementById('barChartComparison').getContext('2d');
      chartInstances.barComparison = new Chart(barCtx, {
        type: 'bar',
        data: { // <-- DÜZELTME: 'data' anahtarı eklendi
          labels: categories,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `${uni1} vs ${uni2} - Kategori Bazlı Karşılaştırma`,
              font: { size: 16, weight: 'bold' },
              color: '#2c3e50'
            },
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20,
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#ddd',
              borderWidth: 1,
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              min: 0,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
              }
            },
            x: {
              grid: {
                display: false,
              }
            }
          }
        }
      });
      
      // Populate comparison university cards
      const universityCardsContainer = document.getElementById('universityCardsComparison');
      universityCardsContainer.innerHTML = '';
      
      [uni1, uni2].forEach((university, uniIndex) => {
        const uniData = data[university] || {};
        let uniCategories = Object.keys(uniData).filter(cat => cat !== EXCLUDED_CATEGORY);
        // Use CATEGORY_ORDER for consistent sorting
        uniCategories = CATEGORY_ORDER.filter(cat => uniCategories.includes(cat));
        
        // Calculate average scores for each category
        const categoryScores = uniCategories.map(category => {
          const catData = uniData[category] || {};
          const scores = years.map(year => catData[year]).filter(score => score !== null && score !== undefined);
          if (scores.length === 0) return { category, avg: 0 };
          const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
          return { category, avg };
        });
        
        // Calculate overall average
        const overallAvg = categoryScores.length > 0 ? 
          (categoryScores.reduce((sum, item) => sum + item.avg, 0) / categoryScores.length) : 0;
        
        // Create card
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">
            <h4 class="card-title text-lg">${university}</h4>
          </div>
          <div class="card-content space-y-3">
            ${categoryScores.slice(0, 4).map((item, index) => {
              const color = index === 0 ? '#3498db' : 
                           index === 1 ? '#e74c3c' : 
                           index === 2 ? '#2ecc71' : '#f39c12';
              return `
                <div class="flex items-center justify-between">
                  <span class="text-sm text-muted">${item.category.split(' ')[0]}</span>
                  <div class="flex items-center space-x-2">
                    <div class="w-16 progress-bar">
                      <div
                        class="progress-fill"
                        style="
                          background-color: ${color};
                          width: ${item.avg}%
                        "
                      ></div>
                    </div>
                    <span class="text-sm font-medium">${item.avg.toFixed(1)}</span>
                  </div>
                </div>
              `;
            }).join('')}
            <div class="pt-2 border-t">
              <div class="flex justify-between items-center">
                <span class="font-medium">Genel Ortalama</span>
                <span class="font-bold text-lg" style="color: ${uniIndex === 0 ? '#3498db' : '#e74c3c'}">
                  ${overallAvg.toFixed(1)}
                </span>
              </div>
            </div>
          </div>
        `;
        universityCardsContainer.appendChild(card);
      });
    }

    // Tab switching logic
    function setupTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetTab = button.getAttribute('data-tab');

          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('tab-active'));
          tabContents.forEach(content => content.classList.add('hidden'));

          // Add active class to clicked button and show corresponding content
          button.classList.add('tab-active');
          const targetContent = document.getElementById(targetTab + 'Tab');
          if (targetContent) {
            targetContent.classList.remove('hidden');
          }
        });
      });
    }

    // Export chart as image (exports the main line chart)
    function exportChart() {
      if (!chartInstances.line) {
        alert('Önce bir grafik oluşturun.');
        return;
      }
      const link = document.createElement('a');
      link.download = 'universite-memnuniyet-grafik.png';
      link.href = chartInstances.line.toBase64Image();
      link.click();
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      setupTabs();
      fetchData();
    });
  </script>
</body>
</html>
